---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import { Image } from 'astro:assets';
import profileImage from '../assets/profile_image.jpg';
import '../styles/home.css';
import fs from 'node:fs';
import path from 'node:path';
import { BibtexParser } from 'bibtex-js-parser';
import { publicationMetadata } from '../data/publications';
import { careerData } from '../data/career';
import { getCollection } from 'astro:content';

const projects = await getCollection('projects');
const projectsData = projects.sort((a, b) => {
	if (a.data.inDevelopment && !b.data.inDevelopment) return -1;
	if (!a.data.inDevelopment && b.data.inDevelopment) return 1;
	return b.data.pubDate.valueOf() - a.data.pubDate.valueOf();
});

const bibPath = path.join(process.cwd(), 'src/assets/scopus.bib');
const bibContent = fs.readFileSync(bibPath, 'utf-8');
const cleanBibContent = bibContent
	.replace(/^[\uFEFF]?Scopus[\s\S]*?@/, '@')
	.replace('10.1115/DETC2025-168422', 'DETC2025-168422')
	.replace(/@CONFERENCE/g, '@inproceedings');
const entries = BibtexParser.parseToJSON(cleanBibContent);

const featuredEntries = entries.filter((entry: any) => {
	const metadata = publicationMetadata[entry.id];
	return metadata?.featured;
}).sort((a: any, b: any) => {
	return parseInt(b.year) - parseInt(a.year);
});

function formatAuthors(authorString: string) {
	if (!authorString) return '';
	const authors = authorString.split(' and ');
	const formattedAuthors = authors.map(auth => {
		const parts = auth.trim().split(',');
		if (parts.length < 2) return auth;
		const surname = parts[0].trim();
		const names = parts[1].trim().split(/\s+/);
		const initials = names.map(n => n[0].toUpperCase() + '.').join(' ');
		return `${surname}, ${initials}`;
	});
	if (formattedAuthors.length === 0) return '';
	if (formattedAuthors.length === 1) return formattedAuthors[0];
	const lastAuthor = formattedAuthors.pop();
	return `${formattedAuthors.join(', ')} and ${lastAuthor}`;
}

const groupedCareerData = careerData.reduce((acc, job) => {
	const lastGroup = acc[acc.length - 1];
	if (lastGroup && lastGroup.company === job.company) {
		lastGroup.jobs.push(job);
	} else {
		acc.push({ company: job.company, jobs: [job] });
	}
	return acc;
}, [] as { company: string; jobs: typeof careerData }[]);
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />

	</head>
	<body id="top" class="home">
		<Header />
		<main>
			<section id="about">
				<div class="hero-content">
					
					<!-- Left Column: Profile -->
					<div class="profile-sidebar">
						<Image src={profileImage} alt="Marco Buttiglione" class="profile-image" />
						<div class="profile-info">
							<h1>Marco Domenico Buttiglione</h1>
							<p class="role">PhD Student &<br>Game Developer</p>
							
							<div class="social-icons">
								<a href="mailto:marcodomenico.buttiglione@gmail.com" aria-label="Email">
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"></rect><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path></svg>
								</a>
								<a href="https://scholar.google.com/citations?user=gbSBgYwAAAAJ" target="_blank" aria-label="Google Scholar">
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
								</a>
								<a href="https://www.linkedin.com/in/marco-dom-buttiglione/" target="_blank" aria-label="LinkedIn">
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg>
								</a>
								<a href="https://github.com/marcobuttiglione" target="_blank" aria-label="GitHub">
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
								</a>
							</div>
						</div>
						<a href="#main-content" class="scroll-down-arrow" aria-label="Scroll down">
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 13l5 5 5-5M7 6l5 5 5-5"/></svg>
						</a>
					</div>

					<!-- Right Column: Content -->
					<div id="main-content" class="main-content">
						<section class="about-section">
							<h2>About Me</h2>
							<p>
								I am a <strong>PhD Student</strong> at Politecnico di Milano and a <strong>Game Developer</strong>. My work lies at the intersection of <strong>Computer Graphics</strong>, <strong>Virtual Reality</strong>, and <strong>Human-Computer Interaction</strong>.
							</p>
							<p>
								My research focuses on developing advanced <strong>physics-based simulations</strong> for medical training, <strong>VR training environments</strong>, and <strong>assistive technologies</strong>. In parallel, I channel my creativity into game development as the director of <strong>Rewind Studios</strong>, currently working on the time-bending puzzle platformer <em>Paradox!</em>.
							</p>
						</section>

						<div class="info-grid">
							<section class="info-column">
								<h3>Interests</h3>
								<ul class="interests-list">
									<li>Computer Graphics</li>
									<li>Virtual Reality</li>
									<li>Game Development</li>
									<li>Human Computer Interaction</li>
								</ul>
							</section>

							<section class="info-column">
								<h3>Education</h3>
								<ul class="education-list">
									<li class="education-item">
										<div class="education-icon">
											<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
										</div>
										<div class="education-details">
											<strong>PhD in Computer Engineering</strong>
											<small>Politecnico di Milano, Current</small>
										</div>
									</li>
									<li class="education-item">
										<div class="education-icon">
											<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
										</div>
										<div class="education-details">
											<strong>M.Sc. in Computer science and engineering</strong>
											<small>Politecnico di Milano, 2024</small>
										</div>
									</li>
									<li class="education-item">
										<div class="education-icon">
											<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
										</div>
										<div class="education-details">
											<strong>B.Sc. in Computer Science and Automation Engineering</strong>
											<small>Politecnico di Bari, 2021</small>
										</div>
									</li>
								</ul>
							</section>
						</div>
					</div>
				</div>
			</section>

			<section class="full-width-section alternate-bg">
				<div class="section-content">
					<h2>Career</h2>
					<ul class="career-list">
						{groupedCareerData.map((group) => (
							<li class="career-company-group">
								{group.jobs.map((job) => (
									<div class="career-item">
										<div class="career-details">
											<strong>{job.role} @ {job.company}</strong>
											<small>{job.startDate} - {job.endDate} | {job.location} {job.type ? `(${job.type})` : ''}</small>
											{job.description && <p>{job.description}</p>}
										</div>
									</div>
								))}
							</li>
						))}
					</ul>
					<a href="/ButtiglioneMARCODOMENICO_Resume.pdf" class="cv-button" download>Download CV</a>
				</div>
			</section>

			<section class="full-width-section projects-section">
				<div class="section-content">
					<h2>Projects</h2>
					
					<div class="carousel-container">
						<div class="carousel-track">
							{projectsData.map((project) => (
								<div class="project-card-link">
									<div class="project-card">
										<div class="image-container">
											{project.data.heroImage && (
                                                typeof project.data.heroImage === 'string' ? (
                                                    <img src={project.data.heroImage} alt={project.data.title} class="project-image" />
                                                ) : (
                                                    <Image src={project.data.heroImage} alt={project.data.title} class="project-image" />
                                                )
                                            )}
											{project.data.inDevelopment && <span class="status-badge">In Development</span>}
										</div>
										<div class="project-content">
											<h3><a href={`/projects/${project.id}`}>{project.data.title}</a></h3>
											{project.data.company && <span class="project-company">{project.data.company}</span>}
											<p>{project.data.description}</p>
											{project.data.tags && (
												<div class="project-tags">
													{project.data.tags.map((tag: string) => <span class="tag">{tag}</span>)}
												</div>
											)}
										</div>
									</div>
								</div>
							))}
							{/* Duplicate for infinite scroll effect */}
							{projectsData.map((project) => (
								<div class="project-card-link" aria-hidden="true">
									<div class="project-card">
										<div class="image-container">
											{project.data.heroImage && (
                                                typeof project.data.heroImage === 'string' ? (
                                                    <img src={project.data.heroImage} alt={project.data.title} class="project-image" />
                                                ) : (
                                                    <Image src={project.data.heroImage} alt={project.data.title} class="project-image" />
                                                )
                                            )}
											{project.data.inDevelopment && <span class="status-badge">In Development</span>}
										</div>
										<div class="project-content">
											<h3><a href={`/projects/${project.id}`} tabindex="-1">{project.data.title}</a></h3>
											{project.data.company && <span class="project-company">{project.data.company}</span>}
											<p>{project.data.description}</p>
											{project.data.tags && (
												<div class="project-tags">
													{project.data.tags.map((tag: string) => <span class="tag">{tag}</span>)}
												</div>
											)}
										</div>
									</div>
								</div>
							))}
						</div>
					</div>

					<div class="carousel-controls">
						<button class="carousel-btn prev" aria-label="Previous projects">
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
						</button>
						<button class="carousel-btn next" aria-label="Next projects">
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
						</button>
					</div>

					<a href="/projects" class="read-more">View all projects &rarr;</a>
				</div>
			</section>

			<section class="full-width-section alternate-bg">
				<div class="section-content">
					<h2>Selected Publications</h2>
					<div class="preview-item">
						<ul class="publication-list-preview">
							{featuredEntries.map((entry: any) => {
								const metadata = publicationMetadata[entry.id];
								return (
								<li>
									<strong>{entry.title}</strong>
									<br/>
									<span class="pub-authors-preview">{formatAuthors(entry.author)}</span>
									<br/>
									<em>{entry.journal || entry.booktitle || 'Conference/Journal'}, {entry.year}</em>
								</li>
							)})}
						</ul>
						<a href="/publications" class="read-more">View all publications &rarr;</a>
					</div>
				</div>
			</section>
		</main>
		<Footer />
		<script>
			const track = document.querySelector('.carousel-track') as HTMLElement | null;
			const container = document.querySelector('.carousel-container') as HTMLElement | null;
			const prevBtn = document.querySelector('.carousel-btn.prev');
			const nextBtn = document.querySelector('.carousel-btn.next');

			if (track && container) {
				let scrollPos = 0;
				let isDragging = false;
				let startX = 0;
				let prevTranslate = 0;
				let isPaused = false;
				let scrollTargetDelta = 0;
				const autoScrollSpeed = 0.5;

				function getSingleSetWidth() {
					return track!.scrollWidth / 2;
				}

				function animate() {
					const maxScroll = getSingleSetWidth();
					
					if (!isDragging) {
						if (Math.abs(scrollTargetDelta) > 0.5) {
							const step = scrollTargetDelta * 0.1;
							scrollPos += step;
							scrollTargetDelta -= step;
						} else {
							scrollTargetDelta = 0;
							if (!isPaused) {
								scrollPos += autoScrollSpeed;
							}
						}
					}

					// Handle wrapping
					if (scrollPos >= maxScroll) {
						scrollPos = scrollPos % maxScroll;
					} else if (scrollPos < 0) {
						scrollPos = maxScroll + (scrollPos % maxScroll);
					}

					track!.style.transform = `translateX(-${scrollPos}px)`;
					requestAnimationFrame(animate);
				}

				// Start animation
				requestAnimationFrame(animate);

				// Pause on hover
				container.addEventListener('mouseenter', () => isPaused = true);
				container.addEventListener('mouseleave', () => {
					if (!isDragging) isPaused = false;
				});

				// Drag functionality
				track.addEventListener('mousedown', (e) => {
					const me = e as MouseEvent;
					isDragging = true;
					isPaused = true;
					scrollTargetDelta = 0;
					startX = me.pageX;
					prevTranslate = scrollPos;
					track!.style.cursor = 'grabbing';
				});

				window.addEventListener('mouseup', () => {
					if (isDragging) {
						isDragging = false;
						isPaused = false;
						track!.style.cursor = 'grab';
					}
				});

				window.addEventListener('mousemove', (e) => {
					if (!isDragging) return;
					const me = e as MouseEvent;
					me.preventDefault();
					const currentX = me.pageX;
					const diff = startX - currentX;
					scrollPos = prevTranslate + diff;
				});

				// Touch events
				track.addEventListener('touchstart', (e) => {
					const te = e as TouchEvent;
					isDragging = true;
					isPaused = true;
					scrollTargetDelta = 0;
					startX = te.touches[0].pageX;
					prevTranslate = scrollPos;
				});

				window.addEventListener('touchend', () => {
					if (isDragging) {
						isDragging = false;
						setTimeout(() => { isPaused = false; }, 1000);
					}
				});

				window.addEventListener('touchmove', (e) => {
					if (!isDragging) return;
					const te = e as TouchEvent;
					const currentX = te.touches[0].pageX;
					const diff = startX - currentX;
					scrollPos = prevTranslate + diff;
				});

				// Buttons
				if (prevBtn) {
					prevBtn.addEventListener('click', () => {
						scrollTargetDelta -= 332; // 300px card + 32px gap (2rem)
					});
				}

				if (nextBtn) {
					nextBtn.addEventListener('click', () => {
						scrollTargetDelta += 332;
					});
				}
			}
		</script>
		<script>
			const arrow = document.querySelector('.scroll-down-arrow');
			if (arrow) {
				window.addEventListener('scroll', () => {
					if (window.scrollY > 20) {
						arrow.classList.add('hidden');
					} else {
						arrow.classList.remove('hidden');
					}
				});

				arrow.addEventListener('click', (e) => {
					// Allow default anchor behavior (smooth scroll via CSS or browser)
					// but hide the arrow immediately
					arrow.classList.add('hidden');
				});
			}
		</script>
	</body>
</html>
