---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import fs from 'node:fs';
import path from 'node:path';
import { toJSON } from 'bibtex-parser-js';
import { Image } from 'astro:assets';
import { publicationMetadata } from '../data/publications';

const bibPath = path.join(process.cwd(), 'src/assets/scopus.bib');
const bibContent = fs.readFileSync(bibPath, 'utf-8');

// Clean up the file content if necessary (remove non-bibtex lines at the top)
// The parser might fail on the header lines "Scopus EXPORT DATE..."
const cleanBibContent = bibContent.replace(/^Scopus[\s\S]*?@/, '@');

const entries = toJSON(cleanBibContent);

// Sort by year descending
const sortedEntries = entries.sort((a: any, b: any) => {
	return parseInt(b.entryTags.YEAR) - parseInt(a.entryTags.YEAR);
});

function formatAuthors(authorString: string) {
	if (!authorString) return '';
	
	const authors = authorString.split(' and ');
	
	const formattedAuthors = authors.map(auth => {
		const parts = auth.trim().split(',');
		if (parts.length < 2) return auth; // Can't parse
		
		const surname = parts[0].trim();
		const names = parts[1].trim().split(/\s+/);
		
		const initials = names.map(n => n[0].toUpperCase() + '.').join(' ');
		
		return `${surname}, ${initials}`;
	});
	
	if (formattedAuthors.length === 0) return '';
	if (formattedAuthors.length === 1) return formattedAuthors[0];
	
	const lastAuthor = formattedAuthors.pop();
	return `${formattedAuthors.join(', ')} and ${lastAuthor}`;
}
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`Publications - ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
		<style>
			.publication-list {
				list-style: none;
				padding: 0;
			}
			.publication-item {
				display: flex;
				gap: 2rem;
				margin-bottom: 2rem;
				padding-bottom: 2rem;
				border-bottom: 1px solid var(--gray-light);
			}
			.publication-item:last-child {
				border-bottom: none;
			}
			.pub-image-container {
				flex-shrink: 0;
				width: 200px;
			}
			.pub-image {
				width: 100%;
				aspect-ratio: 4 / 3;
				object-fit: cover;
				border-radius: 8px;
				box-shadow: var(--box-shadow);
			}
			.pub-content {
				flex-grow: 1;
			}
			.pub-title {
				font-size: 1.2rem;
				font-weight: 700;
				color: var(--black);
				margin-bottom: 0.5rem;
				display: block;
			}
			.pub-authors {
				color: var(--gray-dark);
				margin-bottom: 0.25rem;
				display: block;
			}
			.pub-venue {
				font-style: italic;
				color: var(--gray);
				display: block;
				margin-bottom: 0.5rem;
			}
			.pub-links {
				margin-top: 0.5rem;
				display: flex;
				gap: 1rem;
				flex-wrap: wrap;
			}
			.pub-links a {
				display: inline-flex;
				align-items: center;
				gap: 0.5rem;
				font-size: 0.9rem;
				color: var(--accent);
				text-decoration: none;
				font-weight: 500;
			}
			.pub-links a:hover {
				text-decoration: underline;
			}
			@media (max-width: 720px) {
				.publication-item {
					flex-direction: column;
					gap: 1rem;
				}
				.pub-image-container {
					width: 100%;
					max-width: 300px;
				}
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<section id="publications">
				<h1>Publications</h1>
				<ul class="publication-list">
					{sortedEntries.map((entry: any) => {
						const metadata = publicationMetadata[entry.citationKey];
						return (
						<li class="publication-item">
							{metadata?.image && (
								<div class="pub-image-container">
									<Image src={metadata.image} alt={entry.entryTags.TITLE} class="pub-image" />
								</div>
							)}
							<div class="pub-content">
								<span class="pub-title">{entry.entryTags.TITLE}</span>
								<span class="pub-authors">{formatAuthors(entry.entryTags.AUTHOR)}</span>
								<span class="pub-venue">
									{entry.entryTags.JOURNAL || entry.entryTags.BOOKTITLE || 'Conference/Journal'}, {entry.entryTags.YEAR}
								</span>
								<div class="pub-links">
									{entry.entryTags.DOI && (
										<a href={`https://doi.org/${entry.entryTags.DOI}`} target="_blank">
											DOI
										</a>
									)}									
									{metadata?.video && (
										<a href={metadata.video} target="_blank">
											Video
										</a>
									)}
									{metadata?.code && (
										<a href={metadata.code} target="_blank">
											Code
										</a>
									)}
								</div>
							</div>
						</li>
					)})}
				</ul>
			</section>
		</main>
		<Footer />
	</body>
</html>
