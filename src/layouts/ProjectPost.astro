---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import { Image } from 'astro:assets';

type Props = CollectionEntry<'projects'>['data'];

const { title, description, pubDate, updatedDate, heroImage, company, tags, link, inDevelopment, youtubeVideo, role, projectType, gallery } = Astro.props;

function getEmbedUrl(url: string) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11)
      ? `https://www.youtube.com/embed/${match[2]}`
      : url;
}
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} />
		<style>
			main {
				width: calc(100% - 2em);
				max-width: 100%;
				margin: 0;
			}
			.hero-image {
				width: 100%;
				max-width: 1080px;
				margin: 0 auto;
			}
			.hero-image img {
				display: block;
				margin: 0 auto;
				border-radius: 12px;
				box-shadow: var(--box-shadow);
				width: 100%;
				height: auto;
			}
			.prose {
				width: 1080px;
				max-width: calc(100% - 2em);
				margin: auto;
				padding: 1em;
				color: rgb(var(--gray-dark));
			}
			.prose :global(p) {
				text-align: justify;
				hyphens: auto;
			}
			.title {
				margin-bottom: 1em;
				padding: 1em 0;
				text-align: center;
				line-height: 1;
			}
			.title h1 {
				margin: 0 0 0.5em 0;
			}
			.date {
				margin-bottom: 0.5em;
				color: rgb(var(--gray));
			}
			.last-updated-on {
				font-style: italic;
			}
            .company {
                font-size: 1.2em;
                color: var(--accent);
                margin-bottom: 0.5em;
                display: block;
            }
            .tags {
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
                gap: 0.8rem;
                margin: 1.5rem 0;
            }
            .tag {
                background-color: rgba(var(--gray-light), 0.5);
                color: rgb(var(--gray-dark));
                font-size: 0.95rem;
                padding: 0.4rem 1rem;
                border-radius: 20px;
                border: 1px solid var(--gray);
            }
            .project-link {
                display: block;
                text-align: center;
                margin-top: 2rem;
            }
			.project-meta {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 1.5rem;
				margin: 1.5rem 0;
				padding: 1.5rem;

			}
			.meta-item {
				display: flex;
				flex-direction: column;
				gap: 0.3rem;
			}
			.meta-item.full-width {
				grid-column: 1 / -1;
			}
			.meta-label {
				font-size: 0.75rem;
				text-transform: uppercase;
				letter-spacing: 0.05em;
				color: rgb(var(--gray));
				font-weight: bold;
			}
			.meta-value {
				font-weight: 500;
				color: rgb(var(--gray-dark));
				line-height: 1.4;
			}
			.hero-image {
				width: 100%;
				position: relative;
			}
			.status-badge {
				position: absolute;
				top: 20px;
				right: 20px;
				background-color: #ff9800;
				color: white;
				font-size: 0.9rem;
				font-weight: bold;
				padding: 0.4rem 0.8rem;
				border-radius: 4px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.2);
				text-transform: uppercase;
			}
            .gallery {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
                margin-top: 3rem;
                margin-bottom: 2rem;
            }
            .gallery img {
                width: 100%;
                height: 200px;
                object-fit: cover;
                border-radius: 8px;
                cursor: pointer;
                transition: transform 0.2s;
                box-shadow: var(--box-shadow);
            }
            .gallery img:hover {
                transform: scale(1.02);
            }
            
            /* Modal styles */
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: hidden; /* Prevent scrolling when modal is open */
                background-color: rgba(0,0,0,0.9);
                backdrop-filter: blur(5px);
                /* Flexbox for centering */
                align-items: center;
                justify-content: center;
            }
            .modal-content {
                margin: auto;
                display: block;
                max-width: 90%;
                max-height: 90vh;
                object-fit: contain;
                border-radius: 4px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            }
            .close {
                position: absolute;
                top: 20px;
                right: 30px;
                color: #f1f1f1;
                font-size: 40px;
                font-weight: bold;
                transition: 0.3s;
                cursor: pointer;
                z-index: 1001;
            }
            .close:hover,
            .close:focus {
                color: #bbb;
                text-decoration: none;
                cursor: pointer;
            }
            /* Animation for modal */
            .modal-content {  
                animation-name: zoom;
                animation-duration: 0.3s;
            }
            @keyframes zoom {
                from {transform:scale(0)} 
                to {transform:scale(1)}
            }
            
            .video-container {
                position: relative;
                padding-bottom: 56.25%; /* 16:9 aspect ratio */
                height: 0;
                overflow: hidden;
                border-radius: 12px;
                box-shadow: var(--box-shadow);
            }
            .video-container iframe {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                border: 0;
            }
		</style>
	</head>

	<body>
		<Header />
		<main>
			<article>
				<div class="hero-image">
					{
						youtubeVideo ? (
                            <div class="video-container">
                                <iframe
                                    src={getEmbedUrl(youtubeVideo)}
                                    title="YouTube video player"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                    allowfullscreen
                                />
                            </div>
						) : (
							heroImage && (
                                typeof heroImage === 'string' ? (
                                    <img width={1020} height={510} src={heroImage} alt="" />
                                ) : (
                                    <Image width={1020} height={510} src={heroImage} alt="" />
                                )
                            )
						)
					}
					{inDevelopment && <span class="status-badge">In Development</span>}
				</div>
				<div class="prose">
					<div class="title">
						{inDevelopment ? (
							<div class="date">
								In Development
							</div>
						) : (
							<div class="date">
								<FormattedDate date={pubDate} />
								{
									updatedDate && (
										<div class="last-updated-on">
											Last updated on <FormattedDate date={updatedDate} />
										</div>
									)
								}
							</div>
						)}
						<h2>{title}</h2>
                        {company && <span class="company">{company}</span>}
						
						{(role || projectType) && (
							<div class="project-meta">
								{projectType && (
									<div class="meta-item">
										<span class="meta-label">Project Type</span>
										<span class="meta-value">{projectType}</span>
									</div>
								)}
								{role && (
									<div class="meta-item">
										<span class="meta-label">Role</span>
										<span class="meta-value">{role}</span>
									</div>
								)}
							</div>
						)}

                        {tags && (
                            <div class="tags">
                                {tags.map(tag => <span class="tag">{tag}</span>)}
                            </div>
                        )}

						<hr />
					</div>
					<slot />
                    
                    {gallery && (
                        <div class="gallery">
                            {gallery.map((img) => (
                                <Image 
                                    src={img} 
                                    alt="Project screenshot" 
                                    class="gallery-img" 
                                    width={600} 
                                    height={400} 
                                    data-full-res={typeof img === 'string' ? img : img.src} 
                                />
                            ))}
                        </div>
                    )}
				</div>
			</article>
            
            <!-- Modal -->
            <div id="imageModal" class="modal">
                <span class="close">&times;</span>
                <img class="modal-content" id="modalImg">
            </div>
		</main>
		<Footer />
        
        <script>
            // Get the modal
            const modal = document.getElementById("imageModal");
            const modalImg = document.getElementById("modalImg") as HTMLImageElement;
            const images = document.querySelectorAll(".gallery-img");
            const span = document.getElementsByClassName("close")[0] as HTMLElement;

            if (modal && modalImg && span) {
                images.forEach(img => {
                    img.addEventListener('click', function(this: HTMLImageElement) {
                        modal.style.display = "flex"; // Changed from block to flex for centering
                        // Use the full resolution image source stored in data attribute
                        const fullResSrc = this.getAttribute('data-full-res');
                        modalImg.src = fullResSrc || this.src;
                    });
                });

                span.onclick = function() { 
                    modal.style.display = "none";
                }
                
                modal.onclick = function(e) {
                    if(e.target !== modalImg) {
                        modal.style.display = "none";
                    }
                }
                
                // Close on Escape key
                document.addEventListener('keydown', function(event) {
                    if (event.key === "Escape") {
                        modal.style.display = "none";
                    }
                });
            }
        </script>
	</body>
</html>
